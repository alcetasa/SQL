--------------------------------

------ STG --- ODS --- BDS -----

--1.- CREAR 3 BASES DE DATOS
-- 2.- CREAR SCHEMAS 

CREATE SCHEMA JP

CREATE TABLE JP.TP_CLIENTE
( COD INT
)

---------------------------
CREATE SCHEMA ODS 
CREATE SCHEMA BDS 
-----------------------------------

SELECT CONCAT('SELECT TOP 5 * FROM ',TABLE_NAME)
FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_NAME LIKE 'TAB%'
--PARA VER TODOS LOS SCHEMAS 

SELECT *
FROM INFORMATION_SCHEMA.SCHEMATA

SELECT TOP 5 * FROM TAB_PERSONA

SELECT TOP 5 * FROM TAB_TELEFONO
SELECT TOP 5 * FROM TAB_CORREO

SELECT TOP 5 * FROM TAB_CUENTAPERSONA
SELECT TOP 5 * FROM TAB_SALDOCUENTA

--- CAPA ODS ------
-- CUENTA PERSONA 


SELECT B.COD_PERSONA, A.DOCUMEN_IDENTIDA,A.NRO,
	   A.CTA,A.FEC_CREACION INTO ODS.MD_CUENTA_PERSONA
FROM TAB_CUENTAPERSONA A 
LEFT JOIN TAB_PERSONA B ON A.DOCUMEN_IDENTIDA=B.DOCUMEN_IDENTIDA

SELECT *
FROM ODS.MD_CUENTA_PERSONA

------ SALDO_CUENTA 


SELECT B.COD_PERSONA,A.DOCUMEN_IDENTIDA,A.NRO,A.CTA,
	   CAST( REPLACE(A.MTOSALDO,',','.') AS DECIMAL(18,4)) AS MTOSALDO
	   ,CONVERT(DATE, A.FECDIA,20) AS FEC_DIA INTO ODS.MD_SALDO_CUENTA
FROM TAB_SALDOCUENTA A
LEFT JOIN TAB_PERSONA B ON A.DOCUMEN_IDENTIDA=B.DOCUMEN_IDENTIDA

SELECT *
FROM ODS.MD_SALDO_CUENTA


--ODS CORREO 

SELECT A.COD_PERSONA , A.CORREO,A.TIPESTADO, 
	  CONVERT(DATE,A.FECDIA,20) AS FEC_DIA INTO ODS.MD_CORREO
FROM TAB_CORREO A


-- ODS TELEFONO 

SELECT A.COD_PERSONA,A.TIPTELEFONO,
	   A.TELEFONO,A.TIPESTADO,
	   CONVERT(DATE,A.FECDIA,20) AS FEC_DIA INTO ODS.MD_TELEFONO
FROM TAB_TELEFONO A


--- ODS PERSONA
/* (de 18 a 25) JOVENES
 (de 26 a 30) JOVENES ADULTOS
 (de 31 a 40) ADULTOS
 (de 41 a +)  MAYORES */

SELECT T.* , 
	   CASE 
		   WHEN  EDAD BETWEEN 18 AND 25 THEN 'JOVENES'
		   WHEN  EDAD BETWEEN 26 AND 30 THEN 'JOVENES ADULTOS'
		   WHEN  EDAD BETWEEN 31 AND 40 THEN 'ADULTOS'
		   ELSE 'MAYORES' END AS SEG_CLIENTE INTO ODS.MD_PERSONA
FROM ( SELECT  A.COD_PERSONA,A.APELLIDO_PATERN,A.APELLIDO_MATERN,A.NOMBRES
				,A.TIPO_DOCUMENTO,A.DOCUMEN_IDENTIDA,A.SEXO 
				, CONVERT(DATE, A.FECHA_NACIMIENT,103) AS FEC_NACIMIENTO 
				, DATEDIFF(YEAR,CONVERT(DATE, A.FECHA_NACIMIENT,103),GETDATE()) AS EDAD
		FROM TAB_PERSONA A ) T 

SELECT * FROM ODS.MD_PERSONA 

---------------------------------------------------

--- BDS ----



-- BDS TELEFONO 

--1.- IDENTIFICAR LOS TELF DUPICADOS 

	SELECT TELEFONO INTO TP_TEL_DUPLI
	FROM ODS.MD_TELEFONO
	GROUP BY TELEFONO
	HAVING COUNT(*) > 1 

--2.- ENCONTRAR LOS TELEFONOS UNICOS 
	SELECT A.COD_PERSONA , A.TIPTELEFONO,A.TELEFONO , A.TIPESTADO , 
		  A.FEC_DIA INTO BDS.DIM_TELEFONO 
	FROM ODS.MD_TELEFONO A 
	LEFT JOIN TP_TEL_DUPLI B ON A.TELEFONO=B.TELEFONO
	WHERE B.TELEFONO IS NULL

 -- 3.- ELIMIAR LA TABLA DUPLICADA 
		DROP TABLE TP_TEL_DUPLI



-- BDS CORREO 


---1.- ENCONTRAR LOS DUPLICADOS 

		SELECT CORREO INTO TEMP_DUPLI_CORREO 
		FROM ODS.MD_CORREO
		GROUP BY CORREO 
		HAVING COUNT(*)> 1 

--2.- ENCONTRAR LOS UNICOS 

		SELECT A.* INTO BDS.DIM_CORREO
		FROM ODS.MD_CORREO A 
		LEFT JOIN TEMP_DUPLI_CORREO B ON A.CORREO=B.CORREO
		WHERE B.CORREO IS NULL 

-- 3.- ELIMINAR LA TABLA DUPLICADOS 
DROP TABLE TEMP_DUPLI_CORREO 

--- VARIABLES 

--CODIGO DE PERSONA

		SELECT A.COD_PERSONA , 
			   GETDATE() AS FEC_PROCESO INTO TEMP_1
		FROM ODS.MD_PERSONA A 

		SELECT * FROM TEMP_1

--CUANTOS CORREOS TIENE CADA PERSONA

		
		SELECT A.* , 
			   ISNULL(B.CNT_CORREO,0) AS CNT_CORREO INTO TEMP_2
		FROM TEMP_1 A 
		LEFT JOIN ( SELECT COD_PERSONA , COUNT(*) AS CNT_CORREO
					FROM BDS.DIM_CORREO
					GROUP BY COD_PERSONA ) B ON A.COD_PERSONA=B.COD_PERSONA

		SELECT *
		FROM TEMP_2


--CUANTOS TELÉFONOS TIENE CADA PERSONA

			SELECT A.* , 
				ISNULL(B.CNT_TELEFONO,0) AS CNT_TELEFONO INTO TEMP_3
			FROM TEMP_2 A 
			LEFT JOIN (	SELECT COD_PERSONA ,COUNT(*) AS CNT_TELEFONO 
						FROM BDS.DIM_TELEFONO
						GROUP BY COD_PERSONA) B ON A.COD_PERSONA =B.COD_PERSONA 


--CUANTAS CUENTAS TIENE CADA PERSONA


	SELECT A.* , B.CNT_CUENTAS INTO TEMP_4 
	FROM TEMP_3 A 
	LEFT JOIN (	SELECT COD_PERSONA , COUNT(*) AS CNT_CUENTAS
				FROM ODS.MD_CUENTA_PERSONA
				GROUP BY COD_PERSONA ) B ON A.COD_PERSONA =B.COD_PERSONA
	
	SELECT *
	FROM TEMP_4



--MAYOR ANTIGÜEDAD DE TARJETA POR PERSONA
	
	SELECT A.* , B.FEC_MAS_ANTIGUO INTO TEMP_5
	FROM TEMP_4 A 
	LEFT JOIN ( SELECT COD_PERSONA, MIN(FEC_CREACION) AS FEC_MAS_ANTIGUO
				FROM ODS.MD_CUENTA_PERSONA
				GROUP BY COD_PERSONA ) B ON A.COD_PERSONA =B.COD_PERSONA

	
--MENOR ANTIGÜEDAD DE TARJETA POR PERSONA

		SELECT A.* , B.FEC_MAS_RECIENTE INTO TEMP_6
		FROM TEMP_5 A
		LEFT JOIN (	SELECT COD_PERSONA, MAX(FEC_CREACION) AS FEC_MAS_RECIENTE
					FROM ODS.MD_CUENTA_PERSONA
					GROUP BY COD_PERSONA) B ON A.COD_PERSONA=B.COD_PERSONA 


--SALDO PROMEDIO EN TARJETAS POR PERSONA

	SELECT A.*, B.PROM_SALDO INTO TEMP_7
	FROM TEMP_6 A 
	LEFT JOIN (	SELECT COD_PERSONA , AVG(MTOSALDO) AS PROM_SALDO
				FROM ODS.MD_SALDO_CUENTA
				GROUP BY COD_PERSONA) B ON A.COD_PERSONA=B.COD_PERSONA 

SELECT * INTO BDS.FACT_CAMPAÑAS 
FROM TEMP_7


SELECT *
FROM BDS.FACT_CAMPAÑAS 

DROP TABLE TEMP_1
DROP TABLE TEMP_2
DROP TABLE TEMP_3
DROP TABLE TEMP_4
DROP TABLE TEMP_5
DROP TABLE TEMP_6
DROP TABLE TEMP_7